#!/bin/sh
set -e

# Extrair variÃ¡veis do POSTGRES_URL ou usar variÃ¡veis separadas
POSTGRES_HOST=${POSTGRES_HOST:-localhost}
POSTGRES_PORT=${POSTGRES_PORT:-5432}
POSTGRES_USER=${POSTGRES_USER:-postgres}

echo "â³ Aguardando Postgres em $HOST:$PORT..."
until pg_isready -h "$POSTGRES_HOST" -p "$POSTGRES_PORT" -U "$POSTGRES_USER"; do
  sleep 1
done
echo "âœ… Postgres disponÃ­vel!"

# Rodar migraÃ§Ãµes se necessÃ¡rio
if command -v alembic > /dev/null; then
  echo "ðŸ“¦ Rodando migraÃ§Ãµes..."
  alembic upgrade head
fi

echo "ðŸš€ Iniciando FastAPI..."
exec uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000}
